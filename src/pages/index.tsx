import Head from 'next/head'

import { useState, useEffect, ChangeEvent, FormEvent, useCallback, SetStateAction } from 'react'

import { useUser } from '@clerk/nextjs'
import { NextApiRequest, NextApiResponse } from 'next'
import PostCard from '@/components/PostCard'
import CreatePostWidget from '@/components/CreatePostWidget'
// import { log } from 'next-axiom'

interface IPost {
  id: string,
  content: string,
  createdAt: Date,
  userId: string
}

export default function Home() {
  const [textInput, setTextInput] = useState('')
  const [posts, setPosts] = useState<IPost[]>([])
  const [usernameErr, setUsernameErr] = useState(true)
  const { user } = useUser()

  const renderPosts: JSX.Element[] = posts.map(post => {
    return <PostCard
      key={post.id}
      id={post.id}
      createdAt={post.createdAt}
      content={post.content}
      userId={post.userId}
    />
  })

  const usernameCheck: () => boolean = () => {
    if (user && !user.username) {
      return true
    } else if (user && user.username !== '') {
      return false
    }
    return true
  }

  const checkUser: SetStateAction<boolean> = usernameCheck()

  useEffect(() => {
    const fetchPosts = async () => {
      const res = await fetch('/api/getPosts')
      const data = await res.json()
      if (data && data !== '') setPosts(data)
    }

    fetchPosts()
    setUsernameErr(checkUser), { once: true }
    
  }, [user, checkUser])

  return (
    <>
      <Head>
        <title>Blog</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main>

        {/* Create post */}
        <CreatePostWidget
          user={user}
          textInput={textInput}
          setTextInput={setTextInput}
          usernameErr={usernameErr}
        />

        {/* Display all posts */}
        <div className='flex flex-col items-center justify-center w-screen m-2'>
          {posts ? renderPosts : ''}
        </div>

      </main>
    </>
  )
}
